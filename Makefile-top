# -*- coding: utf-8 -*-

# Requires GNU Make


eq = $(and $(findstring $(1),$(2)),$(findstring $(2),$(1)))
eqs = $(call eq,$(strip $(1)),$(strip $(2)))

TOPDIR = $(abspath $(dir $(lastword $(MAKEFILE_LIST))))

CORPROOT = /v/corpora

# Define EXCLUDE_CORPORA to exclude some corpora that would otherwise be
# included in the package.
EXCLUDE_CORPORA ?=

EMPTY =
SP = $(EMPTY) $(EMPTY)
FILTER_CORPORA = \
	$(if $(EXCLUDE_CORPORA),\
		egrep -v 'korpdata_($(subst $(SP),|,$(strip $(EXCLUDE_CORPORA))))\.tbz',\
		cat)

ISODATE := $(shell date '+%Y%m%d')
MAKE_PKGDATE = $(1)-$(ISODATE)$(2)

PKGDIR = $(TOPDIR)/pkgs
CORP_EXPORT_DIR = $(TOPDIR)/corp/export

BASENAME = $(PKGDIR)/korp_fi

PKG_INFO_FILE = korp-pkg-info.tsv

OVERWRITE ?= days
PREV_PKG_INFO := $(shell ./get-prev-pkg-info.py --overwrite=$(OVERWRITE) \
			$(PKG_INFO_FILE))
OVERWRITE_LAST_PKG_INFO := $(call eqs,yes,$(firstword $(PREV_PKG_INFO)))
PREV_EPOCH := $(word 2,$(PREV_PKG_INFO))
PREV_REV := $(lastword $(PREV_PKG_INFO))

PREV_TIMESTAMP = $(BASENAME)_latest_corpus_packages_newer.timestamp
INSTALLED_LIST = $(BASENAME)_installed_corpora.list

INSTALL_SCRIPT = $(TOPDIR)/korp-install-corpora.sh

TIP_REV = $(shell hg tip --template='{rev}\n')

PKG_corp = $(call MAKE_PKGDATE,$(BASENAME)_corpora)

SRC_TARGETS = backend frontend


.PHONY: all corp src pkgs corp-only src-only $(SRC_TARGETS) cleanup


all: pkgs cleanup

pkgs: corp src

corp-only: corp cleanup

src-only: src cleanup

$(PREV_TIMESTAMP):
	touch --date='@$(PREV_EPOCH)' $@

corp: $(PKG_corp).tar

TAR_CMD = \
	cd $(2); \
	files=`find . -type f $(3)`; \
	if [ "x$$files" != "x" ]; then \
		compr="$(strip $(if $(filter %.tbz %.bz2 %.tbz2,$(1)),j,\
					$(if $(filter %.tgz %.gz,$(1)),z)))"; \
		if [ -e $(1) ]; then \
			rm $(1); \
		fi; \
		tar cv$${compr}pf $(1) $$files; \
	fi

$(PKG_corp).tar: $(PREV_TIMESTAMP) $(INSTALL_SCRIPT) $(INSTALLED_LIST)
	$(MAKE) -C corp
	cp -p $^ $(CORP_EXPORT_DIR)
	$(call TAR_CMD,$@,$(CORP_EXPORT_DIR),\
		-newer $< -name korpdata_\*.tbz | egrep -v test | $(FILTER_CORPORA); echo $(notdir $^))

$(INSTALLED_LIST):
	touch $@

src: $(SRC_TARGETS)

define MAKE_PKG_R
PKG_$(1) = $(call MAKE_PKGDATE,$(BASENAME)_$(1))

$(1): $$(PKG_$(1)).tbz $$(PKG_$(1)).patch.bz2

$$(PKG_$(1)).tbz:
	-rm $$@
	$$(call TAR_CMD,$$@,src/$(1), | egrep -v '(~|\.orig|\.bak)$$$$')

$$(PKG_$(1)).patch.bz2:
	hg diff -r$(PREV_REV) src/$(1) \
	| bzip2 > $$@
endef

$(foreach target,$(SRC_TARGETS),\
	$(eval $(call MAKE_PKG_R,$(target))))

cleanup:
	-rm $(PREV_TIMESTAMP)
ifdef OVERWRITE_LAST_PKG_INFO
	head -n-1 $(PKG_INFO_FILE) > $(PKG_INFO_FILE).tmp
	mv $(PKG_INFO_FILE).tmp $(PKG_INFO_FILE)
endif
	date '+%s	%Y%m%dT%H%M%S	$(TIP_REV)' >> $(PKG_INFO_FILE)
