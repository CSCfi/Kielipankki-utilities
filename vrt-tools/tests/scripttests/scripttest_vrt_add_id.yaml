
# scripttestlib tests for vrt-add-id


# Default input and output

- defaults:
    output:
      # No errors
      returncode: 0
      stderr: ''


# Tests for the functionality of the original script by Jussi
# Piitulainen


- name: 'vrt-add-id: Default options'
  input:
    cmdline: vrt-add-id
    stdin: &input-1 |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a">
      a
      </sentence>
      <sentence a="b">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c">
      c
      </sentence>
      </text>
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="1">
      a
      </sentence>
      <sentence a="b" id="2">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="3">
      c
      </sentence>
      </text>


- name: 'vrt-add-id: --element=text'
  input:
    cmdline: vrt-add-id --element="text"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1" id="1">
      <sentence a="a">
      a
      </sentence>
      <sentence a="b">
      b
      </sentence>
      </text>
      <text n="2" id="2">
      <sentence a="c">
      c
      </sentence>
      </text>


- name: 'vrt-add-id: Non-existent element (no change)'
  input:
    cmdline: vrt-add-id --element=x
    stdin: *input-1
  output:
    stdout: *input-1


- name: 'vrt-add-id: --id'
  input:
    cmdline: vrt-add-id --id="sid"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" sid="1">
      a
      </sentence>
      <sentence a="b" sid="2">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" sid="3">
      c
      </sentence>
      </text>


- name: 'vrt-add-id: --start=0'
  input:
    cmdline: vrt-add-id --start=0
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="0">
      a
      </sentence>
      <sentence a="b" id="1">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="2">
      c
      </sentence>
      </text>


- name: 'vrt-add-id: --prefix'
  input:
    cmdline: vrt-add-id --prefix=s-
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="s-1">
      a
      </sentence>
      <sentence a="b" id="s-2">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="s-3">
      c
      </sentence>
      </text>


- name: 'vrt-add-id: --sort'
  input:
    cmdline: vrt-add-id --element=text --sort
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text id="1" n="1">
      <sentence a="a">
      a
      </sentence>
      <sentence a="b">
      b
      </sentence>
      </text>
      <text id="2" n="2">
      <sentence a="c">
      c
      </sentence>
      </text>


- name: 'vrt-add-id: Existing id attribute (without --force)'
  input:
    cmdline: vrt-add-id --id=a
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
    stderr: |
      vrt-add-id: element has id already
      vrt-add-id: non-zero status 1
    returncode: 1

- name: 'vrt-add-id: Overwrite existing id attribute with --force'
  input:
    cmdline: vrt-add-id --id=a --force
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="1">
      a
      </sentence>
      <sentence a="2">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="3">
      c
      </sentence>
      </text>


- name: 'vrt-add-id: All options'
  input:
    cmdline: vrt-add-id --element=text --id=n --start=0 --prefix=t- --force
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="t-0">
      <sentence a="a">
      a
      </sentence>
      <sentence a="b">
      b
      </sentence>
      </text>
      <text n="t-1">
      <sentence a="c">
      c
      </sentence>
      </text>


# Invalid option values

- name: 'vrt-add-id: Invalid element name'
  input:
    cmdline: vrt-add-id --element="-x"
    stdin: *input-1
  output:
    stdout: ''
    stderr:
      - regex: '^usage'
      - regex: "vrt-add-id: error: argument --element: not a field name: b'-x'"
    returncode: 2

- name: 'vrt-add-id: Invalid attribute name'
  input:
    cmdline: vrt-add-id --id="-x"
    stdin: *input-1
  output:
    stdout: ''
    stderr:
      - regex: '^usage'
      - regex: "vrt-add-id: error: argument --id: not a field name: b'-x'"
    returncode: 2

- name: 'vrt-add-id: Non-integer --start value'
  input:
    cmdline: vrt-add-id --start=x
    stdin: *input-1
  output:
    stdout: ''
    stderr:
      - regex: '^usage'
      - regex: "vrt-add-id: error: argument --start: invalid int value: 'x'"
    returncode: 2

- name: 'vrt-add-id: Invalid --prefix value'
  input:
    cmdline: vrt-add-id --prefix=@x
    stdin: *input-1
  output:
    stdout: ''
    stderr:
      - regex: '^usage'
      - regex: "vrt-add-id: error: argument --prefix: affix out of spec"
    returncode: 2


# Tests for functionality added by Jyrki Niemi


- name: 'vrt-add-id: --type=counter (default)'
  input:
    cmdline: vrt-add-id --type=counter --element=text --id=n --start=0 --prefix=t- --force
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="t-0">
      <sentence a="a">
      a
      </sentence>
      <sentence a="b">
      b
      </sentence>
      </text>
      <text n="t-1">
      <sentence a="c">
      c
      </sentence>
      </text>
  # Check that the command with --no-optimize produces the same result
  transform: &no-optimize
  - {}
  - input:
      cmdline:
        append: ' --no-optimize'


- name: 'vrt-add-id: --type=random (implicit random seed)'
  input:
    cmdline: vrt-add-id --type=random
    stdin: *input-1
  output:
    stdout: &output-random
      regex: |
        <!-- #vrt positional-attributes: word -->
        <text n="1">
        <sentence a="a" id="[0-9a-f]{8}">
        a
        </sentence>
        <sentence a="b" id="[0-9a-f]{8}">
        b
        </sentence>
        </text>
        <text n="2">
        <sentence a="c" id="[0-9a-f]{8}">
        c
        </sentence>
        </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --seed="" (explicit random seed)'
  input:
    cmdline: vrt-add-id --type=random --seed=""
    stdin: *input-1
  output:
    stdout: *output-random
  transform: *no-optimize


- name: 'vrt-add-id: --type=random --seed=1'
  input:
    cmdline: vrt-add-id --type=random --seed=1
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="def75f99">
      a
      </sentence>
      <sentence a="b" id="013ed027">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="0f1462b4">
      c
      </sentence>
      </text>
  transform: *no-optimize


# --type=random --end

- name: 'vrt-add-id: --type=random --end=3'
  input:
    cmdline: vrt-add-id --type=random --end=3 --seed=1
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="1">
      a
      </sentence>
      <sentence a="b" id="2">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="0">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --end=20 (decimal, values of 2 hex digits)'
  input:
    cmdline: vrt-add-id --type=random --end=20 --seed=1
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="0b">
      a
      </sentence>
      <sentence a="b" id="10">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="12">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --end=0x1000 (hex, values of 3 hex digits)'
  input:
    cmdline: vrt-add-id --type=random --end=0x1000 --seed=1
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="b66">
      a
      </sentence>
      <sentence a="b" id="027">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="bb1">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --end=2^8 (power, values of 2 hex digits)'
  input:
    cmdline: vrt-add-id --type=random --end=2^8 --seed=1
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="b6">
      a
      </sentence>
      <sentence a="b" id="02">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="bb">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --end=2 (too small value)'
  input:
    cmdline: vrt-add-id --type=random --end=2 --seed=1
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="1">
      a
      </sentence>
      <sentence a="b" id="0">
      b
      </sentence>
      </text>
      <text n="2">
    stderr: |
      vrt-add-id: more than 2 elements encountered; please increase --end
      vrt-add-id: non-zero status 1
    returncode: 1
  transform: *no-optimize


# --format

- name: 'vrt-add-id: --type=counter --format'
  input:
    cmdline: vrt-add-id --type=counter --start=10 --format="*{id:03x}*"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="*00a*">
      a
      </sentence>
      <sentence a="b" id="*00b*">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="*00c*">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=counter --format --prefix'
  input:
    cmdline: vrt-add-id --type=counter --start=10 --format="*{id:03x}*" --prefix="x-"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="x-*00a*">
      a
      </sentence>
      <sentence a="b" id="x-*00b*">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="x-*00c*">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --format'
  input:
    cmdline: vrt-add-id --type=random --seed=1 --end=10 --format="*{id:03d}*"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="*005*">
      a
      </sentence>
      <sentence a="b" id="*008*">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="*009*">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --format --prefix'
  input:
    cmdline: vrt-add-id --type=random --seed=1 --end=10 --format="*{id:03d}*" --prefix="x-"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="x-*005*">
      a
      </sentence>
      <sentence a="b" id="x-*008*">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="x-*009*">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --type=random --format; double {id}'
  input:
    cmdline: vrt-add-id --type=random --seed=1 --end=100 --format="*{id:03d}-{id:02x}*"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="*045-2d*">
      a
      </sentence>
      <sentence a="b" id="*065-41*">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="*072-48*">
      c
      </sentence>
      </text>
  transform: *no-optimize


# --hash

- name: 'vrt-add-id: --hash; format with {hash}'
  input:
    cmdline: vrt-add-id --type=counter --hash=abc --format="{hash}-{id:03d}"
    stdin: *input-1
  output:
    stdout: &output-hash |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="a9993e364706816aba3e25717850c26c9cd0d89d-001">
      a
      </sentence>
      <sentence a="b" id="a9993e364706816aba3e25717850c26c9cd0d89d-002">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="a9993e364706816aba3e25717850c26c9cd0d89d-003">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --hash; format with {hash1}'
  input:
    cmdline: vrt-add-id --type=counter --hash=abc --format="{hash1}-{id:03d}"
    stdin: *input-1
  output:
    stdout: *output-hash
  transform: *no-optimize

- name: 'vrt-add-id: Multiple --hash'
  input:
    cmdline: vrt-add-id --type=counter --hash=abc --hash=def --hash=ghi --format="{hash1:.4}-{hash2:.4}-{hash3:.6}-{id:03d}"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="a999-589c-481743-001">
      a
      </sentence>
      <sentence a="b" id="a999-589c-481743-002">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="a999-589c-481743-003">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: Format refers to non-existent {hashN}'
  input:
    cmdline: vrt-add-id --type=counter --hash=abc --format="{hash1:.4}-{hash2:.4}-{id:03d}"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
    stderr:
      contains: "KeyError: 'hash2'"
    returncode: 1
  transform: *no-optimize


# --format containing {elem[attr]}

- name: 'vrt-add-id: --format with {elem[attr]}'
  input:
    cmdline: vrt-add-id --type=counter --format="{sentence[a]}-{id:03d}"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="a-001">
      a
      </sentence>
      <sentence a="b" id="b-002">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="c-003">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --format with {elem[attr]} for enclosing elements'
  input:
    cmdline: vrt-add-id --type=counter --format="{text[n]:0>2s}-{paragraph[p]}-{sentence[a]}-{id:03d}"
    stdin: &input-para |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <paragraph p="p1">
      <sentence a="a">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2">
      <sentence a="b">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2">
      <paragraph p="p3">
      <sentence a="c">
      c
      </sentence>
      </paragraph>
      </text>
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <paragraph p="p1">
      <sentence a="a" id="01-p1-a-001">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2">
      <sentence a="b" id="01-p2-b-002">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2">
      <paragraph p="p3">
      <sentence a="c" id="02-p3-c-003">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize


# Format with "{this[attr]}"

- name: 'vrt-add-id: --format with {this[attr]}'
  input:
    cmdline: vrt-add-id --type=counter --format="{this[a]}-{id:03d}"
    stdin: *input-1
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1">
      <sentence a="a" id="a-001">
      a
      </sentence>
      <sentence a="b" id="b-002">
      b
      </sentence>
      </text>
      <text n="2">
      <sentence a="c" id="c-003">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: text, paragraph, sentence with same options and {this[attr]}'
  input:
    cmdline: vrt-add-id --id=xid --type=random --seed=0 --end=2^16 --format="{this[x]}-{id:04x}" --element=text --element=paragraph --element=sentence
    stdin: |
      <!-- #vrt positional-attributes: word -->
      <text x="1">
      <paragraph x="p1">
      <sentence x="a">
      a
      </sentence>
      </paragraph>
      <paragraph x="p2">
      <sentence x="b">
      b
      </sentence>
      </paragraph>
      </text>
      <text x="2">
      <paragraph x="p3">
      <sentence x="c">
      c
      </sentence>
      </paragraph>
      </text>
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text x="1" xid="1-b1fd">
      <paragraph x="p1" xid="p1-b1fd">
      <sentence x="a" xid="a-b1fd">
      a
      </sentence>
      </paragraph>
      <paragraph x="p2" xid="p2-391f">
      <sentence x="b" xid="b-391f">
      b
      </sentence>
      </paragraph>
      </text>
      <text x="2" xid="2-391f">
      <paragraph x="p3" xid="p3-3d2b">
      <sentence x="c" xid="c-3d2b">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize


# Multiple different elements

- name: 'vrt-add-id: text, paragraph, sentence with completely different options'
  input:
    cmdline: vrt-add-id --element=text --type=counter --start=0 --id=tid --element=paragraph --type=counter --start=10 --id=pid --format="p-{id:02x}" --element=sentence --type=random --id=sid --seed=0 --end=2^16 --format="{id:04x}"
    stdin: *input-para
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1" tid="0">
      <paragraph p="p1" pid="p-0a">
      <sentence a="a" sid="b1fd">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2" pid="p-0b">
      <sentence a="b" sid="391f">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2" tid="1">
      <paragraph p="p3" pid="p-0c">
      <sentence a="c" sid="3d2b">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: text, paragraph, sentence with same options'
  input:
    cmdline: vrt-add-id --id=xid --type=random --seed=0 --end=2^16 --format="{id:04x}" --element=text --element=paragraph --element=sentence
    stdin: *input-para
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1" xid="b1fd">
      <paragraph p="p1" xid="b1fd">
      <sentence a="a" xid="b1fd">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2" xid="391f">
      <sentence a="b" xid="391f">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2" xid="391f">
      <paragraph p="p3" xid="3d2b">
      <sentence a="c" xid="3d2b">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: text, paragraph, sentence with default options'
  input:
    cmdline: vrt-add-id --element=text --element=paragraph --element=sentence
    stdin: *input-para
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1" id="1">
      <paragraph p="p1" id="1">
      <sentence a="a" id="1">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2" id="2">
      <sentence a="b" id="2">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2" id="2">
      <paragraph p="p3" id="3">
      <sentence a="c" id="3">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: text, paragraph, sentence with some common options'
  input:
    cmdline: vrt-add-id --id=id --type=random --end=2^16 --format="{id:04x}" --element=text --prefix="t-" --seed=0 --element=paragraph --prefix="p-" --seed=1 --element=sentence --prefix="s-" --seed=2
    stdin: *input-para
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1" id="t-b1fd">
      <paragraph p="p1" id="p-b667">
      <sentence a="a" id="s-7b6f">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2" id="p-027d">
      <sentence a="b" id="s-50dc">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2" id="t-391f">
      <paragraph p="p3" id="p-bb1d">
      <sentence a="c" id="s-275c">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: text, paragraph, sentence; format referring to added ids'
  input:
    cmdline: vrt-add-id --id=id --type=random --end=2^16 --format="{id:04x}" --element=text --prefix="t-" --seed=0 --element=paragraph --format="{text[id]}-p-{id:04x}" --seed=1 --element=sentence --format="{paragraph[id]}-s-{id:04x}" --seed=2
    stdin: *input-para
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1" id="t-b1fd">
      <paragraph p="p1" id="t-b1fd-p-b667">
      <sentence a="a" id="t-b1fd-p-b667-s-7b6f">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2" id="t-b1fd-p-027d">
      <sentence a="b" id="t-b1fd-p-027d-s-50dc">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2" id="t-391f">
      <paragraph p="p3" id="t-391f-p-bb1d">
      <sentence a="c" id="t-391f-p-bb1d-s-275c">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize


# --rename

- name: 'vrt-add-id: --rename, no existing attribute'
  input:
    cmdline: vrt-add-id --id=x --rename
    stdin: &input-multiattr |
      <!-- #vrt positional-attributes: word -->
      <text a="a" n="1" n_1="a" n_2="b">
      <sentence a="a" id="1">
      a
      </sentence>
      <sentence a="b" id="2">
      b
      </sentence>
      </text>
      <text a="a" n="2" n_1="b" n_2="c">
      <sentence a="c" id="3">
      c
      </sentence>
      </text>
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text a="a" n="1" n_1="a" n_2="b">
      <sentence a="a" id="1" x="1">
      a
      </sentence>
      <sentence a="b" id="2" x="2">
      b
      </sentence>
      </text>
      <text a="a" n="2" n_1="b" n_2="c">
      <sentence a="c" id="3" x="3">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --rename without argument, existing attribute'
  input:
    cmdline: vrt-add-id --id=a --rename
    stdin: *input-multiattr
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text a="a" n="1" n_1="a" n_2="b">
      <sentence id="1" a_orig="a" a="1">
      a
      </sentence>
      <sentence id="2" a_orig="b" a="2">
      b
      </sentence>
      </text>
      <text a="a" n="2" n_1="b" n_2="c">
      <sentence id="3" a_orig="c" a="3">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --rename fixed name, existing attribute'
  input:
    cmdline: vrt-add-id --id=a --rename=b
    stdin: *input-multiattr
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text a="a" n="1" n_1="a" n_2="b">
      <sentence id="1" b="a" a="1">
      a
      </sentence>
      <sentence id="2" b="b" a="2">
      b
      </sentence>
      </text>
      <text a="a" n="2" n_1="b" n_2="c">
      <sentence id="3" b="c" a="3">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: --rename with {}, text and sentence, existing attributes'
  input:
    cmdline: vrt-add-id --rename="{}_" --element=text --id=n_1 --element=sentence --id=a
    stdin: *input-multiattr
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text a="a" n="1" n_2="b" n_1_="a" n_1="1">
      <sentence id="1" a_="a" a="1">
      a
      </sentence>
      <sentence id="2" a_="b" a="2">
      b
      </sentence>
      </text>
      <text a="a" n="2" n_2="c" n_1_="b" n_1="2">
      <sentence id="3" a_="c" a="3">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: text and sentence, different renames, existing attributes'
  input:
    cmdline: vrt-add-id --element=text --id=n_1 --rename="{}_" --element=sentence --id=a --rename="{}a"
    stdin: *input-multiattr
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text a="a" n="1" n_2="b" n_1_="a" n_1="1">
      <sentence id="1" aa="a" a="1">
      a
      </sentence>
      <sentence id="2" aa="b" a="2">
      b
      </sentence>
      </text>
      <text a="a" n="2" n_2="c" n_1_="b" n_1="2">
      <sentence id="3" aa="c" a="3">
      c
      </sentence>
      </text>
  transform: *no-optimize

- name: 'vrt-add-id: text and sentence, rename requiring suffix _N, existing attributes'
  input:
    cmdline: vrt-add-id --element=text --id=a --rename=n --element=sentence --id=a --rename=id
    stdin: *input-multiattr
  output:
    stdout: |
      <!-- #vrt positional-attributes: word -->
      <text n="1" n_1="a" n_2="b" n_3="a" a="1">
      <sentence id="1" id_1="a" a="1">
      a
      </sentence>
      <sentence id="2" id_1="b" a="2">
      b
      </sentence>
      </text>
      <text n="2" n_1="b" n_2="c" n_3="a" a="2">
      <sentence id="3" id_1="c" a="3">
      c
      </sentence>
      </text>
  transform: *no-optimize


# Subtitutions in formats

- name: 'vrt-add-id: text, paragraph, sentence; format referring to added ids, with substitutions'
  input:
    cmdline: vrt-add-id --id=id --type=random --end=2^16 --format="{id:04x}" --element=text --prefix="t-" --seed=0 --element=paragraph --format="p-{text[id]/t-//}-{id:04x}" --seed=1 --element=sentence --format="s-{paragraph[id]/p-//,/-/+/}-{id:04x}" --seed=2
    stdin: *input-para
  output:
    stdout: &output-para-subst |
      <!-- #vrt positional-attributes: word -->
      <text n="1" id="t-b1fd">
      <paragraph p="p1" id="p-b1fd-b667">
      <sentence a="a" id="s-b1fd+b667-7b6f">
      a
      </sentence>
      </paragraph>
      <paragraph p="p2" id="p-b1fd-027d">
      <sentence a="b" id="s-b1fd+027d-50dc">
      b
      </sentence>
      </paragraph>
      </text>
      <text n="2" id="t-391f">
      <paragraph p="p3" id="p-391f-bb1d">
      <sentence a="c" id="s-391f+bb1d-275c">
      c
      </sentence>
      </paragraph>
      </text>
  transform: *no-optimize


# idnum[elem] in format

- name: 'vrt-add-id: text, paragraph, sentence; format referring to idnum[elem]'
  input:
    cmdline: vrt-add-id --id=id --type=random --end=2^16 --format="{id:04x}" --element=text --prefix="t-" --seed=0 --element=paragraph --format="p-{idnum[text]:04x}-{id:04x}" --seed=1 --element=sentence --format="s-{idnum[text]:04x}+{idnum[paragraph]:04x}-{id:04x}" --seed=2
    stdin: *input-para
  output:
    # This is another way to achieve the same result as with the
    # substitutions above
    stdout: *output-para-subst
  transform: *no-optimize
