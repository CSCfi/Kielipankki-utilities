Bootstrap: docker
From: python:3.11-slim

%files
    samiasr.py /opt/samiasr/samiasr.py

%post
    apt-get update && apt-get install -y \
        build-essential \
        g++ \
        && pip install --no-cache-dir pip==24.0 \
        && pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu \
        && pip install --no-cache-dir transformers datasets librosa \
        && apt-get purge -y build-essential g++ \
        && apt-get autoremove -y \
        && rm -rf /var/lib/apt/lists/*
    
    export HF_HOME=/tmp/huggingface
    mkdir -p "$HF_HOME" /opt/models
    
    python - <<'EOF'
from transformers import Wav2Vec2Processor, Wav2Vec2ForCTC
import torch
model_name = "GetmanY1/wav2vec2-large-sami-cont-pt-22k-finetuned"
save_path = "/opt/models/getman-wav2vec-large-sami"
processor = Wav2Vec2Processor.from_pretrained(model_name)
model = Wav2Vec2ForCTC.from_pretrained(model_name)
processor.save_pretrained(save_path)
model.save_pretrained(save_path)
EOF
    
    pip cache purge
    rm -rf /tmp/huggingface
    
    # Create extraction helper script
    cat > /usr/local/bin/get_runscript <<'EXTRACT_EOF'
#!/bin/bash
if [ -z "$1" ]; then
    echo "Usage: apptainer exec samiasr_cpu.sif get_runscript OUTPUT_PATH"
    echo "Example: apptainer exec samiasr_cpu.sif get_runscript ./samiasr.py"
    exit 1
fi
cp /opt/samiasr/samiasr.py "$1"
echo "Copied samiasr.py to $1"
echo "Run with: apptainer exec samiasr_cpu.sif python $1 [args...]"
EXTRACT_EOF
    chmod +x /usr/local/bin/get_runscript

%environment
    export MODELS_PATH="/opt/models"

%runscript
    exec python /opt/samiasr/samiasr.py "$@"