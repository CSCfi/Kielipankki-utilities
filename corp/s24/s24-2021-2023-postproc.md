
# Post-processing the Suomi24 2021–2023 VRT data

This document describes the post-processing of the Suomi24 2021–2023
VRT data for importing into Korp.

The data was post-processed by Jyrki Niemi on Puhti between 2025-03-05
and 2025-03-31.


## Intermediate VRT format

The Suomi24 2021–2023 VRT subject to post-processing contained
information produced by the TDPP parser, sentence sentiment polarity
annotator, FiNER and HeLI-OTS 2.0.

At this stage, the VRT data was divided into a threads file for each
year (`threads-202[123].vrt`) and four comments files for each year
(`comments-202[123]-{01-03,04-06,07-09,10-12}.vrt`).


## Post-processing VRT


### Environment

- Post-processing was done under directory
  `/scratch/clarin/tmp/Suomi24-2021-2023/postproc` on Puhti.

- The subdirectory `00-input` contained the intermediate VRT files.

- The subdirectory `s24-2001-2020-thread-info` contained thread
  information files saved from Suomi24 2001–2020, stored in IDA.

- Thread information files for 2021–2023 (and subsequently, 2001–2023)
  were stored to `s24-2021-2023-thread-info`.

- The output of each step was stored in a separate subdirectory whose
  name began was of the form _nn_`-`_name_, where _nn_ is a two-digit
  step number and _name_ a short descriptive name of the step. (In one
  case, two steps have the same number _nn_, suffixed with `a` or
  `b`.)


### Notes

- The post-processing steps described below are represented by Bash
  command lines on Puhti.

- The steps have been documented afterwards, based on Bash
  command-line history, so they may contain errors.

- In many cases, a step required several iterations to get it work
  correctly. The command lines below should represent the final,
  working ones.

- The order of the steps is probably not the most logical. Some steps
  could also have been avoided if some previous one had been done more
  properly.

- Some of the Bash command lines have been slightly edited. In
  particular, many of them have been divided into multiple lines.

- The variable `tab` represents a tab character, set as follows:
  ```bash
  tab="$(printf "\t")"
  ```

- Many of the steps use the [`game`](../../vrt-tools/game) tool for
  running tasks as SLURM batch jobs.

    - The command to run as a batch job may contain several commands
      in a shell pipeline and input and output redirections. To make
      the whole command line an argument to `game`, it is made a
      single quoted argument of `sh -c`. This often makes argument
      quoting within the command line somewhat more complicated.
      Another option would have been to use one-off script files.

    - The time and memory requirements specified with `game` options
      are typically the maximum ones required by the files in a step.

- Many of the steps follow a similar pattern, which could perhaps be
  made a wrapper script.

- Some VRT tools used in the steps were (and some still are)
  development versions with features not yet in the `master` branch of
  Kielipankki-utilities (this repository). Some such cases are noted
  below but not necessarily all.


### Post-processing steps

1. Find comments with thread ids without threads in the threads files:

    ```bash
    # Get thread ids in 2021–2023 and combine with 2001–2020
    grep '^<text' 00-input/threads-202?.vrt |
        perl -pe 's/.* thread_id="(.*?)".*/$1/' |
        sort > thread-ids-s24_2021_2023.tsv
    sort -m s24-2001-2020-thread-info/thread_ids_s24_2001_2020.txt thread-ids-s24_2021_2023.tsv > thread-ids-s24_2001_2023.tsv
    # Get comment thread ids
    grep '^<text' 00-input/comments-*.vrt |
        perl -pe 's/.* thread_id="(.*?)".*/$1/' |
        sort -u > comment-thread-ids-s24_2021_2023.tsv
    # Find thread ids referred to in comments but missing from threads
    LC_ALL=C comm -23 comment-thread-ids-s24_2021_2023.tsv thread-ids-s24_2001_2023.tsv > comment-thread-ids-missing-s24_2021_2023.tsv
    ```

2. Try to retrieve HTML for missing threads to get their topics and
   other thread attributes:

    ```bash
    comm -13 thread-ids-s24_2001_2023.tsv comment-thread-ids-s24_2021_2023.tsv |
        awk '{print "https://keskustelu.suomi24.fi/t/" $1}' > missing-thread-urls.txt
    mkdir s24-2021-2023-missing-threads-html
    wget -P s24-2021-2023-missing-threads-html --wait 5 --random-wait -o wget.log -i missing-thread-urls.txt
    ```

3. Extract thread attributes from HTML for missing threads:

    ```bash
    perl -ne '
            if (/"currentCategories":\["(.*?)"\]/) {
                $topic = $1;
                $topic =~ s/","/ > /g;
            } elsif (m,^\s*\[\{"\@context".*?"name":"(.*?)".+?"dateCreated":"(\d{4}-\d\d-\d\d)T(\d\d:\d\d:\d\d)\..+?"url":"https://keskustelu.suomi24.fi/t/(\d+)/,) {
                $title = $1;
                $datetime = "$2 $3";
                $thread = $4;
                print "$thread\t$datetime\t$title\t$topic\n"
            }' s24-2021-2023-missing-threads-html/* |
        perl -pe 's/>/&gt;/g' |
        sort -t"$tab" -k1,1 > s24_2021_2023_missing-thread-attrs.tsv
    ```

4. Add `ne` structures and their attributes based on positional
   `nertag` attributes (`vrt-augment-name-attrs` from the
   Kielipankki-utilities branch `dev-vrt-augment-name-attrs`):

    ```bash
    bin=$HOME/tmp/Kielipankki-utilities-vrt-augment-name-attrs/vrt-tools
    outdir=01-add-ne-structs;
    for f in 00-input/*.vrt; do
        bn=$(basename $f .vrt);
        game --job augm_ne-$bn --min 15 -C 1 --GiB 2 sh -c "
            $bin/vrt-augment-name-attrs $f > $outdir/$bn.vrt 2> $outdir/$bn.err";
    done
    ```

5. Add the name of the intermediate VRT file of each text (`text`
   attribute `filename_orig`):

    ```bash
    bin=$HOME/tmp/Kielipankki-utilities-vrt-add-struct-attrs/vrt-tools
    for f in 01-add-ne-structs/*.vrt; do
        bn=$(basename $f);
        game --job add_filename_orig-$(basename $bn .vrt) --GiB 2 --min 10 -C 1 \
            $bin/vrt-add-struct-attrs -o 02-add-filename/$bn --fixed "filename_orig=$bn" $f;
    done
    ```

   Here, `vrt-add-struct-attrs` was from the Kielipankki-utilities
   branch `dev-vrt-update-attrs`. The tool was later renamed to
   `vrt-update-attrs`.

6. Add the number of the text in the intermediate VRT file (`text`
   attribute `origfile_textnum`):

    ```bash
    for f in 02-add-filename/*.vrt; do
        bn=$(basename $f);
        game --job add-textnum-$(basename $bn .vrt) -C 1 --GiB 1 --min 10 sh -c "
            perl -pe '
                if (/^<text/) {
                    \$n++; s/>/ origfile_textnum=\"\$n\">/
                }
            ' $f > 03-add-textnum/$bn";
    done
    ```

7. Fix topic names with disordered hierarchy, preserving the original
   in `text` attribute `topic_names_orig`.

   First, create a mapping from disordered topic values to correctly
   ordered ones, mostly based on the topic names in previous years:

    ```bash
    grep '^<text' 00-input/threads-202?.vrt |
        grep -o 'topic_names="[^"]*"' |
        cut -c14- |
        tr -d '"' |
        sed -e 's/&gt;/>/g' |
        sort |
        uniq -c > s24_2021_2023_topic_names_freq.txt
    cut -f4 s24-2001-2020-thread-info/thread-attrs-s24_2001_2020.tsv |
        sort |
        uniq -c > s24_2001_2020_topic_names_freq.txt
    < s24_2001_2020_topic_names_freq.txt perl -ne '
            ($f, $t) = /(\d+)\s(.+)/;
            $ts = join(" > ", sort(split(/ > /, $t)));
            print "$f\t$t\t$ts\n"' |
        sort -t"$tab" -s -k3,3 -k1,1nr > s24_2001_2020_topic_names_freq_norm.tsv
    cut -f2,3 s24_2021_2023_topic_names_freq_norm.tsv |
        LC_ALL=C sort -t"$tab" -k2,2 > s24_2021_2023_topic_names_norm_sort.tsv
    cut -f2,3 s24_2021_2023_topic_names_norm_all_sort.tsv |
        sort -t"$tab" -k1,1 -s > s24_2021_2023_topic_names_map.tsv
    ```

    Find new topics not in 2001–2020 and create a mapping file for
    them:

    ```bash
    LC_ALL=C join -t"$tab" -a1 -j2 s24_2021_2023_topic_names_norm_sort.tsv s24_2001_2020_topic_names_norm_sort.tsv |
        awk -F"$tab" 'NF == 2 && $2 !~ /^(Hidden|Opastus|Suomi24 yritys|Suomi24-old|Tori|oldstuff|\\0)/' > s24_2021_2023_new_topics_norm.txt
    ```

    The file `s24_2021_2023_new_topics_norm.txt` was then edited by
    hand to get the mapping to correctly ordered topic levels. Then
    join to get a mapping to the correct topics for all topics:

    ```bash
    (
        LC_ALL=C join -t"$tab" -a1 -j2 s24_2021_2023_topic_names_norm_sort.tsv s24_2001_2020_topic_names_norm_sort.tsv |
           awk -F"$tab" 'NF != 2';
        cat s24_2021_2023_new_topics_norm.txt
    ) |
        sort -t"$tab" -k2,2 > s24_2021_2023_topic_names_norm_all_sort.tsv
    ```

   Then, use `vrt-add-struct-attrs` with the mapping to add fixed
   topic names, with original names preserved in `topic_names_orig`:

    ```bash
    for f in 03-add-textnum/threads-*.vrt; do
        $bin/vrt-add-struct-attrs --compute 'topic_names_orig=attr["topic_names"]' $f |
        $bin/vrt-add-struct-attrs --data-file s24_2021_2023_topic_names_map.tsv --attr topic_names_orig,topic_names --key topic_names_orig --overwrite topic_names --compute topic_names='val or attr["topic_names_orig"]' > 04-fix-topic-names/$(basename $f);
    done
    ```

   Link comments files from `03-add-textnum`:

    ```bash
    cd 04-fix-topic-names/
    ln -s ../03-add-textnum/comments-202* .
    cd -
    ```

8. Add message type (`msg_type` in `text`):

    ```bash
    for f in 04-fix-topic-names/threads-202*.vrt; do
        $bin/vrt-add-struct-attrs --fixed msg_type="thread_start" $f > 05-add-msg-type/$(basename $f);
    done
    for f in 04-fix-topic-names/comments-202*.vrt; do
        game -C 1 --GiB 1 --min 5 --job add-msg-type-$(basename $f .vrt) \
            $bin/vrt-add-struct-attrs -o 05-add-msg-type/$(basename $f) --fixed msg_type=comment $f; done
    ```

9. Get the thread ids actually in the CWB data for 2001–2020:

    ```bash
    mkdir s24-2001-2020-thread-ids-real
    for y in $(seq 2001 2020); do
        cwb-s-decode -n s24_$y -S text_thread_id |
            sort -u > s24-2001-2020-thread-ids-real/s24_$y-thread-ids-real.txt;
    done
    sort -mu s24-2001-2020-thread-ids-real/*.txt > thread-ids-real-s24_2001_2020.tsv
    ```

10. Extract thread information and combine with that of previous years:

    ```bash
    mkdir s24-2021-2023-thread-info
    # Thread ids (superseded by combined file for thread attributes)
    grep '^<text' 00-input/threads-202?.vrt |
        perl -pe 's/.* thread_id="(.*?)".*/$1/' |
        sort > thread-ids-s24_2021_2023.tsv
    sort -m s24-2001-2020-thread-info/thread_ids_s24_2001_2020.txt thread-ids-s24_2021_2023.tsv > thread-ids-s24_2001_2023.tsv
    sort -m thread-ids-real-s24_2001_2020.tsv thread-ids-s24_2021_2023.tsv > thread-ids-s24_2001_2023.tsv
    # Thread start datetimes (superseded by combined file for thread attributes)
    perl -ne 'if (/^<text.* created="(.*?)".* thread_id="(.*?)"/) {print "$2\t$1\n"}' 05-add-msg-type/threads-*.vrt |
        sort -t"$tab" -k1,1 |
        sort -m -t"$tab" -k1,1 - s24-2001-2020-thread-info/thread-start-datetimes-s24_2001_2020.tsv <(cut -f1,2 s24_2021_2023_missing-thread-attrs.tsv) > s24-2021-2023-thread-info/thread-start-datetimes-s24_2001_2023.tsv
    perl -ne '
            if (/^<text.* closed="(.*?)".* created="(.*?)".* thread_id="(.*?)".* title="(.*?)".* topic_names="(.*?)".* topic_names_orig="(.*?)"/) {
                $cl = ($1 eq "1" ? "y" : "n");
                print "$3\t$2\t$4\t$5\t$6\t$cl\n"
            }
        ' 05-add-msg-type/threads-*.vrt |
        sort -t"$tab" -k1,1 > s24-2021-2023-thread-info/thread-attrs-s24_2021_2023.tsv
    # Add topics_orig to thread attributes
    awk -F"$tab" '{print $0 "\t" $4 "\t"}' s24_2021_2023_missing-thread-attrs.tsv > s24_2021_2023_missing-thread-attrs-extras.tsv
    awk -F"$tab" 'BEGIN{OFS=FS} {print $1, $2, $3, $4, $4, $5}' s24-2001-2020-thread-info/thread-attrs-s24_2001_2020.tsv > s24-2021-2023-thread-info/thread-attrs-s24_2001_2020-extras.tsv
    # Adjust timestamps from UTC to Finnish time
    mv s24_2021_2023_missing-thread-attrs-extras.tsv{,.prev}
    python3 utc-to-fin.py < s24_2021_2023_missing-thread-attrs-extras.tsv.prev > s24_2021_2023_missing-thread-attrs-extras.tsv
    sort -m -t"$tab" -k1,1 s24-2021-2023-thread-info/thread-attrs-s24_2001_2020-extras.tsv s24_2021_2023_missing-thread-attrs-extras.tsv s24-2021-2023-thread-info/thread-attrs-s24_2021_2023.tsv > s24-2021-2023-thread-info/thread-attrs-s24_2001_2023.tsv
    # Closed threads in 2018–2020
    bin2=$HOME/tmp/Kielipankki-utilities-vrt-add-struct-attrs/scripts
    $bin2/cwbdata-structattrs-to-tsv --attribute "msg_type thread_id thread_closed" s24_20{18,19,20} |
        grep '^thread_start' |
        cut -f2,3 |
        sort -t"$tab" -k1,1 > s24_2018_2020_thread_closed.tsv
    join -t"$tab" -j1 -a1 -e "_" -o auto s24-2001-2020-thread-info/thread-attrs-s24_2001_2020.tsv s24_2018_2020_thread_closed.tsv > s24-2001-2020-thread-info/thread-attrs-s24_2001_2020-closed.tsv
    sort -m -t"$tab" -k1,1 s24-2001-2020-thread-info/thread-attrs-s24_2001_2020-closed.tsv s24-2021-2023-thread-info/thread-attrs-s24_2021_2023.tsv > s24-2021-2023-thread-info/thread-attrs-s24_2001_2023.tsv
    # Extract thread information for 2021–2023 and combine with older parts
    perl -ne '
            if (/^<text.* closed="(.*?)".* created="(.*?)".* thread_id="(.*?)".* title="(.*?)".* topic_names="(.*?)".* topic_names_orig="(.*?)"/) {
                print "$3\t$2\t$4\t$5\t$6\t$1\n"
            }
        ' 05-add-msg-type/threads-*.vrt |
        sort -t"$tab" -k1,1 |
        sort -m -t"$tab" -k1,1 - s24-2001-2020-thread-info/thread-attrs-s24_2001_2020.tsv s24_2021_2023_missing-thread-attrs.tsv > s24-2021-2023-thread-info/thread-attrs-s24_2001_2023.tsv
    ```

11. List removed topics:

    ```bash
    LC_ALL=C join -t"$tab" -a1 -j2 s24_2021_2023_topic_names_norm_sort.tsv s24_2001_2020_topic_names_norm_sort.tsv |
        awk -F"$tab" '$2 ~ /^(Hidden|Opastus|Suomi24 yritys|Suomi24-old|Tori|oldstuff|\\0)/' |
        cut -f2 > s24_2021_2023_removed_topics.txt
    ```

12. Add thread attributes:

    ```bash
    # Extract comment thread attributes
    for f in 05-add-msg-type/comments-*.vrt; do
        bn=$(basename $f .vrt);
        game --job extract-comment-thread-attrs-$bn -C1 --min 10 --GiB 4 --scratch 20 sh -c "
            perl -ne '
                if (/^<text/) {
                    \$i++;
                    / thread_id=\"(\\d+)\"/;
                    print \"\$1\\t\$i\\n\"
                }' $f |
            sort -t'$tab' -k1,1 |
            join -t'$tab' -j1 -a1 -e_ -o auto - s24-2021-2023-thread-info/thread-attrs-s24_2001_2023.tsv |
            sort -t'$tab' -k2,2n |
            cut -f1,3-7 > 06-add-thread-attrs/$bn-thread-attrs.tsv";
    done
    # Add thread attributes; rename "closed" to "thread_closed"
    for f in 05-add-msg-type/threads-*.vrt; do
        bn=$(basename $f .vrt);
        sh -c "
            $vt/vrt-add-struct-attrs --compute 'thread_start_datetime=attr[\"created\"]' --compute 'thread_closed=val = attr[\"closed\"]; return \"y\" if val == \"1\" else (\"n\" if val == \"0\" else \"\")' $f |
                vrt-drop-attrs -e text --drop closed > 06-add-thread-attrs/$bn.vrt";
    done
    # Add comment attributes
    for f in 05-add-msg-type/comments-*.vrt; do
        bn=$(basename $f .vrt);
        game --job add-thread-attrs-$bn -C 1 --min 10 --GiB 2 sh -c "
            $vt/vrt-add-struct-attrs --data 06-add-thread-attrs/$bn-thread-attrs.tsv --attributes 'thread_id thread_start_datetime title topic_names topic_names_orig thread_closed' --compute thread_closed='\"y\" if val == \"1\" else (\"n\" if val == \"0\" else \"\")' $f > 06-add-thread-attrs/$bn.vrt 2> 06-add-thread-attrs/$bn.err";
    done
    ```

13. Rename `text` attribute `filename` to `filename_orig` in thread files:

    ```bash
    perl -pe 'if (/^<text/) { s/ filename="/ filename_orig="/ }' 06-add-thread-attrs/threads-2021.vrt > 07-fix-filename-attrname/threads-2021.vrt
    ```

14. Add dummy comment attributes to threads:

    ```bash
    for f in 07-fix-filename-attrname/threads-202*.vrt; do
        $vt/vrt-add-struct-attrs --fixed comment_id=0 --fixed hierarchy_id="" --fixed parent_comment_id=0 --fixed quote_id=0 $f > 08-add-comment-attrs/$(basename $f);
    done
    ```

15. Add message id attribute `msg_id` (combined thread and comment ids):

    ```bash
    for f in 08-add-comment-attrs/*.vrt; do
        bn=$(basename $f .vrt);
        game --job add-msg-id-$bn --GiB 1 --min 5 -C 1 \
            $vt/vrt-add-struct-attrs -o 09-add-msg-id/$bn.vrt --compute id='attr["thread_id"] + ":" + attr["comment_id"]' $f;
    done
    ```

16. Extract message datetimes:

    ```bash
    # Extract message datetimes from missing threads
    grep -Eh '\[\{"@context' s24-2021-2023-missing-threads-html/* |
        perl -ne '
            /"dateCreated":"(\d{4}-\d\d-\d\d)T(\d\d:\d\d:\d\d).*?"url":.+?\/t\/(\d+)/;
            print "$3:0\t$1 $2\n";
            s/^.*?"comment"://;
            while (/"dateCreated":"(\d{4}-\d\d-\d\d)T(\d\d:\d\d:\d\d).*?"url":.+?\/t\/(\d+).+?comment-(\d+)/g) {
                print "$3:$4\t$1 $2\n"
            }' |
        sort -u > s24_2021_2023_missing-thread-msg-datetimes.tsv
    # Extract datetimes from VRT
    for f in 09-add-msg-id/*.vrt; do
        bn=$(basename $f .vrt);
        game --job extract-msg-dates-$bn -C 1 --GiB 2 --min 5 --scratch 8 sh -c "
            perl -ne '
                if (/^<text.* created=\"(.*?)\".* id=\"(.*?)\"/) {
                    print \"\$2\t\$1\n\"
                }' $f |
            sort -t'$tab' -k1,1 > msg-dates/$bn.tsv";
    done
    # Combine
    LC_ALL=C sort -mu s24-2001-2020-thread-info/msg-datetimes-s24_2001_2020.tsv <(LC_ALL=C sort s24_2021_2023_missing-thread-msg-datetimes.tsv msg-dates/*.tsv) > s24-2021-2023-thread-info/msg-datetimes-s24_2001_2023.tsv
    ```

17. Fix missing thread datetimes from UTC to Finnish time. (This would
    have been avoided if I had noticed early enough that the times in
    the HTML for missing threads were in UTC.)

    ```bash
    for f in 09-add-msg-id/threads-*.vrt; do
        bn=$(basename $f .vrt);
        $vt/vrt-add-struct-attrs --data <(cut -f1,2 s24_2021_2023_missing-thread-attrs-extras.tsv) --attr thread_id,created --key thread_id --compute thread_start_datetime="attr['created']" --overwrite created,thread_start_datetime $f > 10a-fix-missing-thread-datetimes/$bn.vrt 2> 10a-fix-missing-thread-datetimes/$bn.err;
    done
    # The same for comments but using "game"
    for f in 09-add-msg-id/comments-*; do
        bn=$(basename $f .vrt);
        game --job fix-missing-thread-datetimes-$bn --GiB 2 --min 5 -C 1 bash -c "
            $vt/vrt-add-struct-attrs --data <(cut -f1,2 s24_2021_2023_missing-thread-attrs-extras.tsv) --attr thread_id,thread_start_datetime --key thread_id --overwrite thread_start_datetime $f > 10a-fix-missing-thread-datetimes/$bn.vrt 2> 10a-fix-missing-thread-datetimes/$bn.err";
    done
    ```

18. Fix parent and quote ids in comments (had `\0` instead of `0`; why?):

    ```bash
    for f in 10a-fix-missing-thread-datetimes/comments-2023-{04,07,10}*.vrt; do
        bn=$(basename $f .vrt);
        perl -pe '
            if (/^<text/) { s/( (parent_comment|quote)_id=)"\\0"/$1"0"/g }
        ' $f > 10b-fix-parent-and-quote-ids/$bn.vrt &
        done
    ```

19. Add parent message datetimes (`text` attribute `parent_datetime`):

    ```bash
    # Extract comment parent datetimes
    for f in 10b-fix-parent-and-quote-ids/comments-*.vrt; do
        bn=$(basename $f .vrt);
        sh -c "
            perl -ne '
                if (/^<text/) {
                    \$i++;
                    / comment_id=\"(\\d+)\".* parent_comment_id=\"(\\d+)\".* thread_id=\"(\\d+)\"/;
                    print \"\$3:\$2\\t\$3:\$1\\t\$i\\n\"
                }' $f |
                LC_ALL=C sort -t'$tab' -k1,1 |
                LC_ALL=C join -t'$tab' -j1 -a1 -e_ -o auto - s24-2021-2023-thread-info/msg-datetimes-s24_2001_2023.tsv |
                LC_ALL=C sort -t'$tab' -k3,3n |
                cut -f2,4 |
                tr -d _ > 11-add-parent-datetime/$bn-parent-datetimes.tsv" &
    done
    # Add parent datetimes
    for f in 10b-fix-parent-and-quote-ids/comments-*.vrt; do
        bn=$(basename $f .vrt);
        $vt/vrt-add-struct-attrs --data 11-add-parent-datetime/$bn-parent-datetimes.tsv --attr id,parent_datetime $f > 11-add-parent-datetime/$bn.vrt 2> 11-add-parent-datetime/$bn.err &
    done
    ```

20. Add a dummy empty message if a message is completely without
     content. This uses a preliminary version of `vrt-add-dummy`,
     which is not yet in the `master` branch of Kielipankki-utilities.

    ```bash
    for f in 11-add-parent-datetime/*.vrt; do
        bn=$(basename $f .vrt);
        game --job add-dummy-$bn --GiB 1 --min 5 -C 1 sh -c "
            $vt/vrt-add-dummy --attr pos=Punct --attr ref=1 --attr dephead=0 --attr deprel=root --attr initid=1 --attr lex='|_..xx.1|' --attr nertags2='|' --attr nerbio2=O --intermediate 'paragraph type=empty sum_lang=|' --intermediate 'sentence lang=\"\" lang_conf=\"\" sentiment_polarity=neut' $f > 12-add-dummy-empty-msg/$bn.vrt";
    done
    ```

21. Combine threads and comments to yearly files and sort by thread:

    ```bash
    for y in 202{1,2,3}; do
        game --job sort-by-thread-s24_$y --min 90 --scratch 20 -C 4 --GiB 4 sh -c "
            {
                cat 12-add-dummy-empty-msg/threads-$y.vrt;
                grep -v '^<\!--' 12-add-dummy-empty-msg/comments-$y*.vrt;
            } |
                $vt/vrt-sort --key 'thread_id created' --transform thread_id:\"f'{val:0>10}'\" > 13-sort-by-thread/s24_$y.vrt";
    done
    ```

22. Add thread sort key (`text` attribute `_sort_key`):

    ```bash
    vt=$HOME/tmp/Kielipankki-utilities-vrt-add-struct-attrs/vrt-tools
    for f in 13-sort-by-thread/s24_202?.vrt; do
        $vt/../corp/s24/s24-vrt-add-thread-sort-attr.py --sort-key=_sort_key < $f > 14-add-thread-sort-key/$(basename $f);
    done
    ```

23. Sort messages within threads:

    ```bash
    for f in 14-add-thread-sort-key/s24_202?.vrt; do
        bn=$(basename $f .vrt);
        # Sorting is faster if the file is first copied to $TMPDIR
        # (local scratch) on the compute node
        tf='$'TMPDIR/$bn.vrt;
        game --job sort-threads-$bn --GiB 4 --scratch 50 --min 180 sh -c "
            cp -p $f $tf;
            $vt/vrt-sort --key=_sort_key < $tf > 15-sort-threads/$bn.vrt;
            rm $tf";
    done
    ```

24. Split years to files of at most 250,000 `text`s, keeping in the
     same file texts with the same `thread_id` value:

    ```bash
    vrt-split --output '16-split-files/{basename}_{num1:02d}{ext}' --max-structs 250000 --omit --keep-together thread_id 15-sort-threads/s24_202?.vrt
    ```

25. Add derived topic attributes (`topic_names_set`, `topic_name_top`,
    `topic_name_leaf`, `topic_adultonly`):

    ```bash
    for f in 16-split-files/s24_202?_*.vrt; do
        bn=$(basename $f .vrt);
        game --job add-topic-attrs-$bn --GiB 2 --min 20 -C1 sh -c "
            $vt/vrt-add-struct-attrs --compute topic_names_set='topics=attr[\"topic_names\"].split(\" &gt; \"); attr[\"topic_name_top\"] = topics[0]; attr[\"topic_name_leaf\"] = topics[-1]; return \"|\" + \"|\".join(topics) + \"|\"' --compute topic_adultonly='\"y\" if attr[\"topic_name_top\"] == \"Seksi\" else \"n\"' $f > 17-add-topic-attrs/$bn.vrt";
    done
    ```

26. Add separate `date` and `time` attributes to `text`s:

    ```bash
    for f in 17-add-topic-attrs/*.vrt; do
        bn=$(basename $f .vrt);
        game --job add-date-time-$bn -C1 --GiB 1 --min 5 sh -c "
            $vt/vrt-add-struct-attrs --compute date=\"attr['created'].partition(' ')[0]\" --compute time=\"attr['created'].partition(' ')[2]\" $f > 18-add-date-time/$bn.vrt";
    done
    ```

27. Add `text` attributes `author_logged_in` and
     `author_nick_registered` (mainly for backward-compatibility):

    ```bash
    for f in 18-add-date-time/*.vrt; do
        bn=$(basename $f .vrt); game --job add-author-attrs-$bn --GiB 1 --min 10 -C1 sh -c "$vt/vrt-add-struct-attrs --compute author_logged_in=\"'n' if attr['user_id'] == '0' else 'y'\" --compute author_nick_registered=\"attr['author_logged_in']\" --fixed author_name_type=user_nickname $f > 19-add-author-attrs/$bn.vrt"; done
    ```

28. Add `text` attribute `vrt_filename` (the split VRT filename):

    ```bash
    for f in 19-add-author-attrs/*.vrt; do
        bn=$(basename $f .vrt);
        game --job add-vrt-filename-$bn --GiB 1 --min 5 -C1 sh -c "
            $vt/vrt-add-struct-attrs --fixed filename_vrt=$bn.vrt $f > 20-add-vrt-filename/$bn.vrt";
    done
    ```

29. Add `text` attribute `datetime_approx` (with fixed value `n`, for
     backward-compatibility):

    ```bash
    for f in 20-add-vrt-filename/*.vrt; do
        bn=$(basename $f .vrt);
        game --job add-datetime-approx-$bn --GiB 1 --min 5 -C1 sh -c "
            $vt/vrt-add-struct-attrs --fixed datetime_approximated=n $f > 21-add-datetime-approx/$bn.vrt";
    done
    ```

30. Rename some `text` attributes (`anonnick` -> `author`, `created`
     -> `datetime`, `quote_id` -> `quoted_comment_id`):

    ```bash
    for f in 21-add-datetime-approx/*.vrt; do
        bn=$(basename $f .vrt); game --job rename-struct-attrs-$bn --GiB 1 --min 5 -C1 sh -c "
            module load python-data/3.10 > /dev/null;
            $vt/vrt-rename-attrs --struct text --map 'anonnick:author' --map 'created:datetime' --map 'quote_id:quoted_comment_id' --map 'id:msg_id' $f > 22-rename-struct-attrs/$bn.vrt";
    done
    ```

31. Reorder `text` attributes to a somehow more logical order:

    ```bash
    for f in 22-rename-struct-attrs/*; do
        bn=$(basename $f .vrt);
        game --job rename-struct-attrs-$bn --GiB 1 --min 5 -C1 sh -c "
            module load python-data/3.10 > /dev/null;
            $vt/vrt-unify-attrs --input-order --struct text --first 'msg_type thread_id comment_id msg_id parent_comment_id quoted_comment_id date time datetime thread_start_datetime parent_datetime datetime_approximated author author_logged_in author_nick_registered author_name_type user_id title topic_names topic_names_set topic_name_top topic_name_leaf topic_adultonly topic_names_orig thread_closed deleted empty hierarchy_id datefrom dateto timefrom timeto filename_vrt filename_orig origfile_textnum sum_lang _sort_key' $f > 23-reorder-struct-attrs/$bn.vrt";
    done
    ```

32. Remove `text` attribute `deleted` as the data does not contain
     deleted messages:

    ```bash
    for f in 23-reorder-struct-attrs/*.vrt; do
        bn=$(basename $f .vrt);
        game --job rm-attr-deleted-$bn --GiB 1 --min 5 -C1 sh -c "
            module load python-data/3.10 > /dev/null;
            $vt/vrt-drop-attrs --struct text --drop deleted $f > 24-rm-attr-deleted/$bn.vrt";
    done
    ```

33. Remove messages in hidden topics:

    ```bash
    for f in 24-rm-attr-deleted/*.vrt; do
        bn=$(basename $f .vrt);
        game --job rm-hidden-topics-$bn --GiB 1 --min 5 -C1 sh -c "
            module load python-data/3.10 > /dev/null;
            $vts/vrt-select --drop --test topic_names='(Hidden|Opastus|Suomi24 yritys|Suomi24-old|Tori|oldstuff|usetracetesting|\\0).*' $f > 25-rm-hidden-topics/$bn.vrt";
    done
    ```

34. Remove spurious spaces (leading, trailing, double) in `text`
     attributes `title` and `topic_names` and those derived from the
     latter, and add `title_orig` for the original one with spurious
     spaces (`topic_names_orig` already existed):

    ```bash
    for f in 25-rm-hidden-topics/*.vrt; do
        bn=$(basename $f .vrt);
        game --job fix-spaces-$bn -C1 --min 5 --GiB 2 sh -c "
            $vt/vrt-add-struct-attrs --compute title_orig=\"attr['title']\" --compute title='s/  +/ /g' --compute topic_name_leaf='s/  +/ /g' --compute topic_names='s/  +/ /g' --compute topic_names_set='s/  +/ /g' --compute topic_name_leaf='s/^ +//' --compute topic_name_leaf='s/ +$//' --compute topic_names_set='s/ *\| */|/g' $f > 26-fix-topic-title-spaces/$bn.vrt";
    done
    ```

35. Reorder `text` attribute `title_orig`. Note that this step would
     have been avoided if the spurious spaces had been removed before
     reordering `text` attributes.

    ```bash
    for f in 26-fix-topic-title-spaces/*; do
        bn=$(basename $f .vrt);
        game --job rename-struct-attrs-$bn --GiB 1 --min 5 -C1 sh -c "
            module load python-data/3.10 > /dev/null;
            $vt/vrt-unify-attrs --input-order --struct text --first 'msg_type thread_id comment_id msg_id parent_comment_id quoted_comment_id date time datetime thread_start_datetime parent_datetime datetime_approximated author author_logged_in author_nick_registered author_name_type user_id title title_orig topic_names topic_names_set topic_name_top topic_name_leaf topic_adultonly topic_names_orig thread_closed deleted empty hierarchy_id datefrom dateto timefrom timeto filename_vrt filename_orig origfile_textnum sum_lang _sort_key' $f > 27-reorder-title-orig/$bn.vrt";
    done
    ```

36. Fix to remove spurious attributes: `empty` from other structures
     than `text` and `_skip` with an empty value in `sentence`. The
     latter had been added by `vrt-unify-attrs`.

    ```bash
    for f in 27-reorder-title-orig/*.vrt; do
        bn=$(basename $f .vrt);
        game --job rm-spurious-attrs-$bn -C1 --min 5 --GiB 1 sh -c "
            module load python-data/3.10 > /dev/null;
            $vt/vrt-drop-attrs --drop empty -e text --keep empty $f |
                perl -pe 'if (/^<sentence/) {s/ _skip=\"\"//}' > 28-fix-rm-spurious-attrs/$bn.vrt";
    done
    ```

37. Fix to remove hidden topic `\0` (should have been removed earlier
     but the test for `\0` was probably incorrect) and orphan comments
     (comments without thread information, thus with `topic_names`
     value `_`); these were present only in some files:

    ```bash
    for f in 28-fix-rm-spurious-attrs/s24_202{1_{07,19},2_{11,15},3_{08,10,11,12,19}}.vrt; do
        bn=$(basename $f .vrt);
        game --job fix-rm-hidden-orphan-$bn --GiB 1 --min 5 -C1 sh -c "
            module load python-data/3.10 > /dev/null;
            $vts/vrt-select --drop --test topic_names='(\\\\0|_)' $f > 29-fix-rm-hidden-topics-orphan-comments/$bn.vrt";
    done
    ```

38. Fix topic names with “Työ ja opiskelu, Työpaikkailmoitukset” and
     “Työpaikkailmoitukset > Työ ja opiskelu” to “Työ ja opiskelu >
     Työpaikkailmoitukset”:

    ```bash
    for f in 29-fix-rm-hidden-topics-orphan-comments/*.vrt; do
        bn=$(basename $f .vrt);
        game --job fix-topic-tyopaikkailm-$bn -C1 --min 5 --GiB 2 sh -c "
            $vt/vrt-add-struct-attrs --compute topic_names='s/(Työ ja opiskelu), (Työpaikkailmoitukset)/\1 &gt; \2/' --compute topic_names='s/(Työpaikkailmoitukset)( &gt; )(Työ ja opiskelu)/\3\2\1/' --compute topic_names_set='s/(Työ ja opiskelu), (Työpaikkailmoitukset)/\1|\2/' --compute topic_names_set='s/(Työpaikkailmoitukset)\|(Työ ja opiskelu)/\2|\1/' --compute topic_name_top='s/, Työpaikkailmoitukset//' --compute topic_name_top='s/Työpaikkailmoitukset/Työ ja opiskelu/' --compute topic_name_leaf='s/Työ ja opiskelu, //' $f > 30-fix-topic-names-tyopaikkailm/$bn.vrt";
    done
    ```

39. Combine the messages for each year to a single VRT file:

    ```bash
    for y in 202{1,2,3}; do
        {
            cat 30-fix-topic-names-tyopaikkailm/s24_${y}_01.vrt;
            tail -n+2 -q 30-fix-topic-names-tyopaikkailm/s24_${y}_{0[2-9],[12]?}.vrt;
        } > 31-combine-years/s24_$y.vrt &
    done
    ```

40. Unnest `ne` structures to explicit `ne`, `ne1`, `ne2`. (This would
     not have been needed if I had made `vrt-augment-name-attrs` to
     produce them in the first place. That is still a task to do.)

    ```bash
    for f in 31-combine-years/*.vrt; do
        bn=$(basename $f .vrt);
        game --job unnest-ne-$bn -C1 --min 20 --GiB 1 sh -c "
            perl -pe '
                if (/^<ne /) {
                    if (\$d > 0) {
                        s/^<ne/<ne\$d/
                    }
                    \$d++
                } elsif (/^<\/ne>/) {
                    \$d--;
                    if (\$d > 0) {
                        s/^<\/ne/<\/ne\$d/
                    }
                }
            ' $f > 32-unnest-ne/$bn.vrt";
    done
    ```


# Create Korp corpus packages with `korp-make`

```bash
ln -sfn 32-unnest-ne 99-final
for f in 99-final/s24_202?.vrt; do
    bn=$(basename $f .vrt);
    game --job korp-make-$bn --hour 12 --GiB 32 --scratch 120 -C1 \
        korp-make --force --times $bn $f;
done
```
