Set variables in file alto-xml2vrt-dirs-new.sh:
 - scriptdir
 - outputdir
 - copy_all_vrtfiles
 - linkingfile

Set variables in check-and-renumber-sentences.sh:
 - vrt_validate

Dependencies of alto-xml2vrt-dirs-new.sh:

alto-xml2vrt-dirs-new.sh
  - conv-new.py
    - vrt_util.py
      - finnish-tokenize command line tool
    - mets.py
  - mets2metadata.py
    - mets.py

Process all source directories with alto-xml2vrt-dirs-new.sh. It is probably
easiest first to split large directories into smaller ones and then generate
commands for batch scripts that should terminate within a given number of hours.

An example:

Split all directories with:

for dir in finclarin_siirto/*/*/alto;
do
    ./split-dir.sh $dir 200000;
done
for dir in finclarin_siirto/*/*/orig_alto/;
do
    rm -r $dir;
done

Then generate batch commands with:

list-dirs.sh finclarin_siirto | \
combine-dirs.sh 200000 | \
dirs-into-game-commands.sh "game --cores=1" "alto-xml2vrt-dirs-new.sh" 100000 > COMMANDS

For more information, see batch_scripts/README.

Then zip the source files:

zip -r finclarin_siirto.zip finclarin_siirto

Copy finclarin_siirto.zip and COMMANDS, extract finclarin_siirto.zip
and run all batch commands in COMMANDS.


Basically, VRT files are generated from XML files for a given set of directories
with the command:

  alto-xml2vrt-dirs-new.sh "DIR_1 DIR_2 ... DIR_N"

e.g.

  alto-xml2vrt-dirs-new.sh "0025-5149/1937/alto 0025-5149/1938/alto"

which will create

- outputdir/0025-5149/1937/alto/FILE_1.vrt
- outputdir/0025-5149/1937/alto/FILE_2.vrt
- ...
- outputdir/0025-5149/1937/alto/FILE_N.vrt

- outputdir/0025-5149/1938/alto/FILE_1.vrt
- outputdir/0025-5149/1938/alto/FILE_2.vrt
- ...
- outputdir/0025-5149/1938/alto/FILE_N.vrt

Each VRT file will be a concatenation of files that use the same metadata file.

Then analyze the VRT files. Splitting long sentences is advisable. For example
vrt-conll09-mend does this by default after the limit of 1 000 words is reached.

After analyzing, search for possible splitted sentences and rename their
ids with command

  ./check-and-renumber-sentences.sh outputdir

Then generate the corpus package for each year YEAR with command

  ... outputdir/*/YEAR/*/*.vrt


An example of rerunning the commands:

Get commands from file COMMANDS_klk_s2015 that did not finish due to time limit
with new reserved time of 4 hours (possibly removing old *.err and *.out files first):

for file in gamelog/*.err; do if (tail -2 $file | grep 'TIME LIMIT' > /dev/null); then echo $file; fi; done > TIME_LIMIT
# for file in `cat TIME_LIMIT`; do rm $file; done
# for file in `cat TIME_LIMIT | perl -pe 's/\.err/\.out/;'`; do rm $file; done
cat TIME_LIMIT | perl -pe 's/.*(klk_[0-9]+)\.err/grep " --job=\1 " COMMANDS_klk_s2015/;' | sh | perl -pe 's/ \-\-hours=[0-9]/ --hours=4/;'

Get commands from file COMMANDS_klk_s2015 that did not finish succesfully
(possibly removing old *.err and *.out files first):

for file in gamelog/*.out; do if (tail -2 $file | grep 'STATUS 1' > /dev/null); then echo $file; fi; done > STATUS_1
# for file in `cat STATUS_1`; do rm $file; done
# for file in `cat STATUS_1 | perl -pe 's/\.out/\.err/;'`; do rm $file; done
cat STATUS_1 | perl -pe 's/.*(klk_[0-9]+)\.out/grep " --job=\1 " COMMANDS_klk_s2015/;' | sh
